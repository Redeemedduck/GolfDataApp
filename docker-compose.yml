# ==============================================================================
# Docker Compose Configuration for Golf Data Analysis App
# ==============================================================================
# This file orchestrates the containerized application with proper volume
# mounting and environment configuration. It's optimized for OrbStack on macOS.
#
# Usage:
#   docker-compose up -d          # Start in background
#   docker-compose up             # Start with logs visible
#   docker-compose down           # Stop and remove containers
#   docker-compose logs -f        # View logs
#   docker-compose restart        # Restart the application
# ==============================================================================

services:
  # ----------------------------------------------------------------------------
  # Golf Data App Service
  # ----------------------------------------------------------------------------
  golf-app:
    # Image name and tag
    image: golf-data-app:latest

    # Container name (easier to reference than random names)
    container_name: golf-data-app

    # Build configuration
    build:
      context: .
      dockerfile: Dockerfile

    # Port mapping: host:container
    # Access the app at http://localhost:8501
    ports:
      - "8501:8080"

    # Environment variables
    # Option 1: Load from .env file (recommended for secrets)
    env_file:
      - .env

    # Option 2: Set specific environment variables here
    # Uncomment and customize as needed
    # environment:
    #   - STREAMLIT_SERVER_PORT=8501
    #   - STREAMLIT_SERVER_ADDRESS=0.0.0.0

    # Volume mounts for persistent data
    # Format: host_path:container_path:options
    volumes:
      # SQLite database persistence
      # This ensures your golf data survives container restarts
      - ./data:/app/data

      # Media files (shot images, etc.)
      - ./media:/app/media

      # Application logs
      - ./logs:/app/logs

      # Optional: Mount .env file directly if you prefer
      # - ./.env:/app/.env:ro

      # Optional: Mount specific Python files for development
      # This allows you to edit code without rebuilding the image
      # ONLY USE DURING DEVELOPMENT - remove for production!
      # - ./app.py:/app/app.py:ro
      # - ./golf_scraper.py:/app/golf_scraper.py:ro
      # - ./golf_db.py:/app/golf_db.py:ro

    # Restart policy
    # "unless-stopped" means container restarts automatically unless you explicitly stop it
    restart: unless-stopped

    # Health check (optional - uses the one defined in Dockerfile)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource limits (optional but recommended for production)
    # These prevent the container from consuming all system resources
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M

    # Logging configuration (optional)
    # Controls how much log data Docker stores
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==============================================================================
# Named Volumes (Optional Alternative to Bind Mounts)
# ==============================================================================
# Uncomment this section if you prefer Docker-managed volumes instead of
# bind mounts. Named volumes are more portable but harder to access directly.
#
# volumes:
#   golf-data:
#     driver: local
#   golf-media:
#     driver: local
#   golf-logs:
#     driver: local
#
# Then update the service volumes section to:
#   volumes:
#     - golf-data:/app/data
#     - golf-media:/app/media
#     - golf-logs:/app/logs

# ==============================================================================
# Networks (Optional)
# ==============================================================================
# If you need to connect this to other containers (e.g., a database),
# you can define custom networks here.
#
# networks:
#   golf-network:
#     driver: bridge
