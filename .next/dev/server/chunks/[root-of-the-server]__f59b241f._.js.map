{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 154, "column": 0}, "map": {"version":3,"sources":["file:///Users/duck/Public/golf-data-app/src/lib/bigquery.ts"],"sourcesContent":["import { BigQuery } from '@google-cloud/bigquery';\n\nconst projectId = process.env.GCP_PROJECT_ID || 'valued-odyssey-474423-g1';\nconst dataset = process.env.BQ_DATASET_ID || 'golf_data';\nconst table = process.env.BQ_TABLE_ID || 'shots';\n\nlet bigqueryClient: BigQuery | null = null;\n\nfunction getBigQueryClient() {\n  if (!bigqueryClient) {\n    bigqueryClient = new BigQuery({ projectId });\n  }\n  return bigqueryClient;\n}\n\nexport interface GolfStats {\n  totalShots: number;\n  avgCarry: number;\n  avgSmash: number;\n  avgBallSpeed: number;\n  clubs: string[];\n  recentSessions: number;\n}\n\nexport interface ClubPerformance {\n  club: string;\n  shots: number;\n  avgCarry: number;\n  avgSmash: number;\n  avgBallSpeed: number;\n  consistency: number;\n}\n\nexport async function getOverallStats(days: number = 30): Promise<GolfStats> {\n  const client = getBigQueryClient();\n\n  const query = `\n    SELECT\n      COUNT(*) as total_shots,\n      ROUND(AVG(carry), 1) as avg_carry,\n      ROUND(AVG(smash), 2) as avg_smash,\n      ROUND(AVG(ball_speed), 1) as avg_ball_speed,\n      STRING_AGG(DISTINCT club ORDER BY club) as clubs,\n      COUNT(DISTINCT session_id) as sessions\n    FROM \\`${projectId}.${dataset}.${table}\\`\n    WHERE DATE(date_added) >= DATE_SUB(CURRENT_DATE(), INTERVAL ${days} DAY)\n      AND carry > 0\n  `;\n\n  const [rows] = await client.query({ query });\n\n  if (rows.length === 0 || rows[0].total_shots === 0) {\n    return {\n      totalShots: 0,\n      avgCarry: 0,\n      avgSmash: 0,\n      avgBallSpeed: 0,\n      clubs: [],\n      recentSessions: 0,\n    };\n  }\n\n  const row = rows[0];\n  return {\n    totalShots: parseInt(row.total_shots),\n    avgCarry: parseFloat(row.avg_carry),\n    avgSmash: parseFloat(row.avg_smash),\n    avgBallSpeed: parseFloat(row.avg_ball_speed),\n    clubs: row.clubs ? row.clubs.split(',') : [],\n    recentSessions: parseInt(row.sessions),\n  };\n}\n\nexport async function getClubPerformance(days: number = 30): Promise<ClubPerformance[]> {\n  const client = getBigQueryClient();\n\n  const query = `\n    SELECT\n      club,\n      COUNT(*) as shots,\n      ROUND(AVG(carry), 1) as avg_carry,\n      ROUND(AVG(smash), 2) as avg_smash,\n      ROUND(AVG(ball_speed), 1) as avg_ball_speed,\n      ROUND(STDDEV(carry), 1) as consistency\n    FROM \\`${projectId}.${dataset}.${table}\\`\n    WHERE DATE(date_added) >= DATE_SUB(CURRENT_DATE(), INTERVAL ${days} DAY)\n      AND carry > 0\n    GROUP BY club\n    ORDER BY avg_carry DESC\n  `;\n\n  const [rows] = await client.query({ query });\n\n  return rows.map((row: any) => ({\n    club: row.club,\n    shots: parseInt(row.shots),\n    avgCarry: parseFloat(row.avg_carry),\n    avgSmash: parseFloat(row.avg_smash),\n    avgBallSpeed: parseFloat(row.avg_ball_speed),\n    consistency: parseFloat(row.consistency || 0),\n  }));\n}\n\nexport async function getRecentShots(club?: string, limit: number = 10) {\n  const client = getBigQueryClient();\n\n  const clubFilter = club ? `AND club = '${club}'` : '';\n\n  const query = `\n    SELECT\n      shot_id,\n      session_id,\n      club,\n      carry,\n      total,\n      smash,\n      ball_speed,\n      club_speed,\n      launch_angle,\n      side_spin,\n      back_spin,\n      DATE(date_added) as shot_date\n    FROM \\`${projectId}.${dataset}.${table}\\`\n    WHERE carry > 0\n      ${clubFilter}\n    ORDER BY date_added DESC\n    LIMIT ${limit}\n  `;\n\n  const [rows] = await client.query({ query });\n  return rows;\n}\n\nexport async function executeCustomQuery(userQuery: string): Promise<any> {\n  const client = getBigQueryClient();\n\n  // For safety, we'll provide a sanitized interface\n  // In production, you'd want more sophisticated query validation\n  const [rows] = await client.query({ query: userQuery });\n  return rows;\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAEA,MAAM,YAAY,QAAQ,GAAG,CAAC,cAAc,IAAI;AAChD,MAAM,UAAU,QAAQ,GAAG,CAAC,aAAa,IAAI;AAC7C,MAAM,QAAQ,QAAQ,GAAG,CAAC,WAAW,IAAI;AAEzC,IAAI,iBAAkC;AAEtC,SAAS;IACP,IAAI,CAAC,gBAAgB;QACnB,iBAAiB,IAAI,oLAAQ,CAAC;YAAE;QAAU;IAC5C;IACA,OAAO;AACT;AAoBO,eAAe,gBAAgB,OAAe,EAAE;IACrD,MAAM,SAAS;IAEf,MAAM,QAAQ,CAAC;;;;;;;;WAQN,EAAE,UAAU,CAAC,EAAE,QAAQ,CAAC,EAAE,MAAM;gEACqB,EAAE,KAAK;;EAErE,CAAC;IAED,MAAM,CAAC,KAAK,GAAG,MAAM,OAAO,KAAK,CAAC;QAAE;IAAM;IAE1C,IAAI,KAAK,MAAM,KAAK,KAAK,IAAI,CAAC,EAAE,CAAC,WAAW,KAAK,GAAG;QAClD,OAAO;YACL,YAAY;YACZ,UAAU;YACV,UAAU;YACV,cAAc;YACd,OAAO,EAAE;YACT,gBAAgB;QAClB;IACF;IAEA,MAAM,MAAM,IAAI,CAAC,EAAE;IACnB,OAAO;QACL,YAAY,SAAS,IAAI,WAAW;QACpC,UAAU,WAAW,IAAI,SAAS;QAClC,UAAU,WAAW,IAAI,SAAS;QAClC,cAAc,WAAW,IAAI,cAAc;QAC3C,OAAO,IAAI,KAAK,GAAG,IAAI,KAAK,CAAC,KAAK,CAAC,OAAO,EAAE;QAC5C,gBAAgB,SAAS,IAAI,QAAQ;IACvC;AACF;AAEO,eAAe,mBAAmB,OAAe,EAAE;IACxD,MAAM,SAAS;IAEf,MAAM,QAAQ,CAAC;;;;;;;;WAQN,EAAE,UAAU,CAAC,EAAE,QAAQ,CAAC,EAAE,MAAM;gEACqB,EAAE,KAAK;;;;EAIrE,CAAC;IAED,MAAM,CAAC,KAAK,GAAG,MAAM,OAAO,KAAK,CAAC;QAAE;IAAM;IAE1C,OAAO,KAAK,GAAG,CAAC,CAAC,MAAa,CAAC;YAC7B,MAAM,IAAI,IAAI;YACd,OAAO,SAAS,IAAI,KAAK;YACzB,UAAU,WAAW,IAAI,SAAS;YAClC,UAAU,WAAW,IAAI,SAAS;YAClC,cAAc,WAAW,IAAI,cAAc;YAC3C,aAAa,WAAW,IAAI,WAAW,IAAI;QAC7C,CAAC;AACH;AAEO,eAAe,eAAe,IAAa,EAAE,QAAgB,EAAE;IACpE,MAAM,SAAS;IAEf,MAAM,aAAa,OAAO,CAAC,YAAY,EAAE,KAAK,CAAC,CAAC,GAAG;IAEnD,MAAM,QAAQ,CAAC;;;;;;;;;;;;;;WAcN,EAAE,UAAU,CAAC,EAAE,QAAQ,CAAC,EAAE,MAAM;;MAErC,EAAE,WAAW;;UAET,EAAE,MAAM;EAChB,CAAC;IAED,MAAM,CAAC,KAAK,GAAG,MAAM,OAAO,KAAK,CAAC;QAAE;IAAM;IAC1C,OAAO;AACT;AAEO,eAAe,mBAAmB,SAAiB;IACxD,MAAM,SAAS;IAEf,kDAAkD;IAClD,gEAAgE;IAChE,MAAM,CAAC,KAAK,GAAG,MAAM,OAAO,KAAK,CAAC;QAAE,OAAO;IAAU;IACrD,OAAO;AACT"}},
    {"offset": {"line": 284, "column": 0}, "map": {"version":3,"sources":["file:///Users/duck/Public/golf-data-app/src/lib/gemini.ts"],"sourcesContent":["import { GoogleGenerativeAI } from '@google/generative-ai';\nimport { getOverallStats, getClubPerformance, getRecentShots } from './bigquery';\n\nconst apiKey = process.env.GEMINI_API_KEY;\n\nlet genAI: GoogleGenerativeAI | null = null;\n\nfunction getGeminiClient() {\n  if (!genAI && apiKey) {\n    genAI = new GoogleGenerativeAI(apiKey);\n  }\n  return genAI;\n}\n\nexport interface ChatContext {\n  conversationHistory: Array<{\n    role: 'user' | 'model';\n    parts: string;\n  }>;\n}\n\nexport async function generateGolfInsights(\n  userMessage: string,\n  context?: ChatContext\n): Promise<string> {\n  const client = getGeminiClient();\n\n  if (!client) {\n    throw new Error('Gemini API key not configured');\n  }\n\n  // Fetch recent golf data from BigQuery\n  const [stats, clubPerf] = await Promise.all([\n    getOverallStats(30),\n    getClubPerformance(30),\n  ]);\n\n  // Build context about the golfer's data\n  const dataContext = `\nYou are an expert golf coach analyzing shot data from a TrackMan/Uneekor launch monitor.\nThis golfer practices at Denver altitude (5,280 ft).\n\nCURRENT PERFORMANCE DATA (Last 30 Days):\n- Total Shots: ${stats.totalShots}\n- Practice Sessions: ${stats.recentSessions}\n- Clubs Used: ${stats.clubs.join(', ')}\n- Average Carry: ${stats.avgCarry.toFixed(1)} yards\n- Average Smash Factor: ${stats.avgSmash.toFixed(2)}\n- Average Ball Speed: ${stats.avgBallSpeed.toFixed(1)} mph\n\nCLUB-BY-CLUB PERFORMANCE:\n${clubPerf.map(c => `\n- ${c.club}:\n  * ${c.shots} shots\n  * Avg Carry: ${c.avgCarry.toFixed(1)} yards\n  * Smash Factor: ${c.avgSmash.toFixed(2)}\n  * Ball Speed: ${c.avgBallSpeed.toFixed(1)} mph\n  * Consistency (Std Dev): ${c.consistency.toFixed(1)} yards\n`).join('')}\n\nINSTRUCTIONS:\n- Provide specific, actionable insights based on the data above\n- Reference actual numbers from their performance\n- Compare to PGA Tour averages when relevant (adjusted for Denver altitude)\n- Be encouraging but honest about areas needing improvement\n- For questions about specific clubs, focus your analysis on that club's data\n- If asked about trends, note that you're analyzing the last 30 days\n- Keep responses concise and focused (2-3 paragraphs max)\n`;\n\n  const model = client.getGenerativeModel({\n    model: 'gemini-1.5-flash',\n    systemInstruction: dataContext,\n  });\n\n  // Build conversation history\n  const history = context?.conversationHistory || [];\n\n  const chat = model.startChat({\n    history: history.map(msg => ({\n      role: msg.role,\n      parts: [{ text: msg.parts }],\n    })),\n  });\n\n  const result = await chat.sendMessage(userMessage);\n  const response = result.response;\n  return response.text();\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;AAEzC,IAAI,QAAmC;AAEvC,SAAS;IACP,IAAI,CAAC,SAAS,QAAQ;QACpB,QAAQ,IAAI,sLAAkB,CAAC;IACjC;IACA,OAAO;AACT;AASO,eAAe,qBACpB,WAAmB,EACnB,OAAqB;IAErB,MAAM,SAAS;IAEf,IAAI,CAAC,QAAQ;QACX,MAAM,IAAI,MAAM;IAClB;IAEA,uCAAuC;IACvC,MAAM,CAAC,OAAO,SAAS,GAAG,MAAM,QAAQ,GAAG,CAAC;QAC1C,IAAA,2IAAe,EAAC;QAChB,IAAA,8IAAkB,EAAC;KACpB;IAED,wCAAwC;IACxC,MAAM,cAAc,CAAC;;;;;eAKR,EAAE,MAAM,UAAU,CAAC;qBACb,EAAE,MAAM,cAAc,CAAC;cAC9B,EAAE,MAAM,KAAK,CAAC,IAAI,CAAC,MAAM;iBACtB,EAAE,MAAM,QAAQ,CAAC,OAAO,CAAC,GAAG;wBACrB,EAAE,MAAM,QAAQ,CAAC,OAAO,CAAC,GAAG;sBAC9B,EAAE,MAAM,YAAY,CAAC,OAAO,CAAC,GAAG;;;AAGtD,EAAE,SAAS,GAAG,CAAC,CAAA,IAAK,CAAC;EACnB,EAAE,EAAE,IAAI,CAAC;IACP,EAAE,EAAE,KAAK,CAAC;eACC,EAAE,EAAE,QAAQ,CAAC,OAAO,CAAC,GAAG;kBACrB,EAAE,EAAE,QAAQ,CAAC,OAAO,CAAC,GAAG;gBAC1B,EAAE,EAAE,YAAY,CAAC,OAAO,CAAC,GAAG;2BACjB,EAAE,EAAE,WAAW,CAAC,OAAO,CAAC,GAAG;AACtD,CAAC,EAAE,IAAI,CAAC,IAAI;;;;;;;;;;AAUZ,CAAC;IAEC,MAAM,QAAQ,OAAO,kBAAkB,CAAC;QACtC,OAAO;QACP,mBAAmB;IACrB;IAEA,6BAA6B;IAC7B,MAAM,UAAU,SAAS,uBAAuB,EAAE;IAElD,MAAM,OAAO,MAAM,SAAS,CAAC;QAC3B,SAAS,QAAQ,GAAG,CAAC,CAAA,MAAO,CAAC;gBAC3B,MAAM,IAAI,IAAI;gBACd,OAAO;oBAAC;wBAAE,MAAM,IAAI,KAAK;oBAAC;iBAAE;YAC9B,CAAC;IACH;IAEA,MAAM,SAAS,MAAM,KAAK,WAAW,CAAC;IACtC,MAAM,WAAW,OAAO,QAAQ;IAChC,OAAO,SAAS,IAAI;AACtB"}},
    {"offset": {"line": 366, "column": 0}, "map": {"version":3,"sources":["file:///Users/duck/Public/golf-data-app/src/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { generateGolfInsights, ChatContext } from '@/lib/gemini';\n\nexport const runtime = 'nodejs';\nexport const dynamic = 'force-dynamic';\nexport const maxDuration = 60; // Allow up to 60 seconds for AI response\n\n// In-memory conversation storage (in production, use Redis or database)\nconst conversations = new Map<string, ChatContext>();\n\n/**\n * Chat API Route - Integrates with Gemini AI + BigQuery\n *\n * This endpoint provides conversational golf data analysis powered by:\n * - Gemini AI for intelligent coaching insights\n * - BigQuery for real-time access to shot data\n * - Conversation memory for multi-turn dialogues\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const { message, sessionId, conversationHistory } = await request.json();\n\n    if (!message) {\n      return NextResponse.json(\n        { error: 'Message is required' },\n        { status: 400 }\n      );\n    }\n\n    // Get or create conversation context\n    const currentSessionId = sessionId || `session-${Date.now()}`;\n    let context = conversations.get(currentSessionId);\n\n    if (!context && conversationHistory) {\n      context = { conversationHistory };\n      conversations.set(currentSessionId, context);\n    }\n\n    // Generate AI response with BigQuery data\n    const aiResponse = await generateGolfInsights(message, context);\n\n    // Update conversation history\n    if (context) {\n      context.conversationHistory.push(\n        { role: 'user', parts: message },\n        { role: 'model', parts: aiResponse }\n      );\n    } else {\n      conversations.set(currentSessionId, {\n        conversationHistory: [\n          { role: 'user', parts: message },\n          { role: 'model', parts: aiResponse },\n        ],\n      });\n    }\n\n    return NextResponse.json({\n      response: aiResponse,\n      sessionId: currentSessionId,\n      timestamp: new Date().toISOString(),\n    });\n\n  } catch (error) {\n    console.error('Chat API error:', error);\n\n    // Provide user-friendly error messages\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';\n\n    if (errorMessage.includes('API key')) {\n      return NextResponse.json(\n        { error: 'AI service not configured. Please set GEMINI_API_KEY environment variable.' },\n        { status: 503 }\n      );\n    }\n\n    if (errorMessage.includes('BigQuery')) {\n      return NextResponse.json(\n        { error: 'Database connection error. Please check BigQuery configuration.' },\n        { status: 503 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: `Failed to process chat message: ${errorMessage}` },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;;;AAEO,MAAM,UAAU;AAChB,MAAM,UAAU;AAChB,MAAM,cAAc,IAAI,yCAAyC;AAExE,wEAAwE;AACxE,MAAM,gBAAgB,IAAI;AAUnB,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,SAAS,EAAE,mBAAmB,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEtE,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsB,GAC/B;gBAAE,QAAQ;YAAI;QAElB;QAEA,qCAAqC;QACrC,MAAM,mBAAmB,aAAa,CAAC,QAAQ,EAAE,KAAK,GAAG,IAAI;QAC7D,IAAI,UAAU,cAAc,GAAG,CAAC;QAEhC,IAAI,CAAC,WAAW,qBAAqB;YACnC,UAAU;gBAAE;YAAoB;YAChC,cAAc,GAAG,CAAC,kBAAkB;QACtC;QAEA,0CAA0C;QAC1C,MAAM,aAAa,MAAM,IAAA,8IAAoB,EAAC,SAAS;QAEvD,8BAA8B;QAC9B,IAAI,SAAS;YACX,QAAQ,mBAAmB,CAAC,IAAI,CAC9B;gBAAE,MAAM;gBAAQ,OAAO;YAAQ,GAC/B;gBAAE,MAAM;gBAAS,OAAO;YAAW;QAEvC,OAAO;YACL,cAAc,GAAG,CAAC,kBAAkB;gBAClC,qBAAqB;oBACnB;wBAAE,MAAM;wBAAQ,OAAO;oBAAQ;oBAC/B;wBAAE,MAAM;wBAAS,OAAO;oBAAW;iBACpC;YACH;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,UAAU;YACV,WAAW;YACX,WAAW,IAAI,OAAO,WAAW;QACnC;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mBAAmB;QAEjC,uCAAuC;QACvC,MAAM,eAAe,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAE9D,IAAI,aAAa,QAAQ,CAAC,YAAY;YACpC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA6E,GACtF;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,aAAa,QAAQ,CAAC,aAAa;YACrC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAkE,GAC3E;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,CAAC,gCAAgC,EAAE,cAAc;QAAC,GAC3D;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}