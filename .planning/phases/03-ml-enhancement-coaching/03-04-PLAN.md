---
phase: 03-ml-enhancement-coaching
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/prediction_interval.py
  - components/retraining_ui.py
  - components/__init__.py
  - pages/4_ðŸ¤–_AI_Coach.py
autonomous: true

must_haves:
  truths:
    - "User sees prediction with confidence interval displayed visually (point estimate + shaded range)"
    - "User can click a button in the UI to trigger model retraining"
    - "Retraining shows progress feedback and completes in <60 seconds"
    - "New model version is saved with metadata (training date, sample size, metrics)"
  artifacts:
    - path: "components/prediction_interval.py"
      provides: "render_prediction_interval() Streamlit component showing interval visualization"
      contains: "render_prediction_interval"
    - path: "components/retraining_ui.py"
      provides: "render_retraining_ui() Streamlit component with retrain button and progress"
      contains: "render_retraining_ui"
    - path: "pages/4_ðŸ¤–_AI_Coach.py"
      provides: "AI Coach page with retraining and interval sections"
      contains: "render_retraining_ui"
  key_links:
    - from: "components/retraining_ui.py"
      to: "ml/train_models.py"
      via: "DistancePredictor.train_with_intervals()"
      pattern: "train_with_intervals|DistancePredictor"
    - from: "components/prediction_interval.py"
      to: "ml/train_models.py"
      via: "predict_with_intervals result dict"
      pattern: "lower_bound|upper_bound"
    - from: "pages/4_ðŸ¤–_AI_Coach.py"
      to: "components/retraining_ui.py"
      via: "render call"
      pattern: "render_retraining_ui"
---

<objective>
Build UI components for prediction interval visualization and model retraining trigger, then integrate them into the AI Coach page.

Purpose: Users see trustworthy interval predictions visually and can retrain models on-demand from the UI (COACH-03 UI + MONTR-02 partial).

Output: Two new Streamlit components (prediction_interval, retraining_ui) wired into AI Coach page.
</objective>

<execution_context>
@/Users/max1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/max1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@components/__init__.py
@pages/4_ðŸ¤–_AI_Coach.py
@.planning/phases/03-ml-enhancement-coaching/03-01-SUMMARY.md
@.planning/phases/03-ml-enhancement-coaching/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prediction interval and retraining UI components</name>
  <files>components/prediction_interval.py, components/retraining_ui.py, components/__init__.py</files>
  <action>
  1. **Create `components/prediction_interval.py`** with `render_prediction_interval()`:
     - Function signature: `render_prediction_interval(prediction: dict, club: str = None) -> None`
     - Expects prediction dict with: predicted_value, lower_bound, upper_bound, confidence_level, interval_width, has_intervals
     - If `has_intervals` is False: show st.metric with point estimate only, st.caption noting intervals unavailable
     - If `has_intervals` is True:
       * st.metric showing "Predicted Carry" with value and delta ("+/- {interval_width/2:.0f} yards")
       * st.caption: "{confidence_level*100:.0f}% confidence interval: {lower_bound:.0f}-{upper_bound:.0f} yards"
       * Plotly visualization: horizontal line from lower_bound to upper_bound (light blue, width=8) with point estimate marker (blue dot, size=12)
       * Layout: xaxis_title="Carry Distance (yards)", yaxis hidden, height=150, no legend
       * st.plotly_chart with use_container_width=True
     - Follow existing component patterns: stateless, `render_*()` naming convention

  2. **Create `components/retraining_ui.py`** with `render_retraining_ui()`:
     - Function signature: `render_retraining_ui() -> None`
     - Import ml module components with try/except (ML_AVAILABLE, DistancePredictor, get_model_info, HAS_MAPIE)
     - Show current model info section:
       * Call get_model_info(DISTANCE_MODEL_PATH) for metadata
       * If metadata exists: show version, trained_at, training_samples, metrics (MAE, R2) as st.metrics
       * If no metadata: show "No model trained yet"
     - Retrain button:
       * st.button("Retrain Model", type="primary", use_container_width=True)
       * When clicked:
         - Show st.spinner("Training model... This takes <60 seconds")
         - Create DistancePredictor()
         - Get df from golf_db.get_all_shots()
         - If df has < 50 shots: st.error("Need 50+ shots to train")
         - Call predictor.train_with_intervals(df) if HAS_MAPIE else predictor.train(df)
         - Show st.success with new metadata: MAE, samples, training time
         - Store training result in st.session_state.last_training for persistence
     - If ML not available: st.warning with install instructions
     - If model exists, show "Try a prediction" expander:
       * Input sliders: ball_speed (100-200, default 150), launch_angle (5-25, default 12), back_spin (1000-5000, default 2500)
       * On "Predict" button: call predictor.predict_with_intervals() if available, else predict()
       * Render result using render_prediction_interval() from sibling component

  3. **Update `components/__init__.py`**:
     - Add imports: `from .prediction_interval import render_prediction_interval`
     - Add import: `from .retraining_ui import render_retraining_ui`
     - Add both to __all__ list

  Key patterns to follow:
  - Existing components are stateless with `render_*(data, **kwargs) -> None`
  - Use plotly.graph_objects (already in codebase), not matplotlib
  - All ML imports guarded with try/except
  - Use st.session_state for persistence across reruns
  </action>
  <verify>
  python -m py_compile components/prediction_interval.py
  python -m py_compile components/retraining_ui.py
  python -m py_compile components/__init__.py
  python -c "from components import render_prediction_interval, render_retraining_ui; print('Component imports OK')"
  </verify>
  <done>
  - render_prediction_interval shows point estimate + interval visualization with Plotly
  - render_retraining_ui shows model info, retrain button with spinner, prediction tester
  - Both follow existing component conventions (stateless render_* pattern)
  - All files pass py_compile
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate retraining UI and interval display into AI Coach page</name>
  <files>pages/4_ðŸ¤–_AI_Coach.py</files>
  <action>
  Modify `pages/4_ðŸ¤–_AI_Coach.py` to add model management and interval prediction sections:

  1. **Add imports** at top:
     - `from components import render_retraining_ui, render_prediction_interval`
     - `from local_coach import LocalCoach` (for practice plan access)

  2. **Add "Model Management" section in sidebar** (below existing "Your Data" section):
     - st.divider()
     - st.subheader("ML Model")
     - Add a compact model status indicator:
       * Import get_model_info and DISTANCE_MODEL_PATH from ml.train_models (guarded)
       * If model exists: show st.caption("Model: v{version}, MAE: {mae:.1f}yd")
       * If no model: show st.caption("No model trained")
     - Add st.button("Retrain Model", key="sidebar_retrain") that sets st.session_state.show_retrain = True

  3. **Add retraining panel** in main content area:
     - After the chat interface section, add:
     - If st.session_state.get('show_retrain'):
       * st.divider()
       * render_retraining_ui()
       * st.button("Close", on_click to clear show_retrain)

  4. **Add practice plan quick action** in suggested questions:
     - Add to suggested_questions list: "Generate a personalized practice plan for me"
     - Add: "What are my biggest weaknesses?"

  5. **Wire prediction intervals into chat context**:
     - In the help section at bottom, add bullet: "**Prediction Intervals**: Ask 'Predict my 7-iron distance' to see predictions with confidence intervals"

  Key constraints:
  - Do NOT restructure the existing chat flow â€” add alongside it
  - All new features behind try/except guards (ML may not be available)
  - Retraining panel appears below chat, not replacing it
  - Keep the page clean â€” model management is secondary to chat
  </action>
  <verify>
  python -m py_compile "pages/4_ðŸ¤–_AI_Coach.py"
  python -c "import importlib.util; spec = importlib.util.spec_from_file_location('coach', 'pages/4_ðŸ¤–_AI_Coach.py'); print('AI Coach page compiles OK')"
  </verify>
  <done>
  - AI Coach page has sidebar model status and retrain button
  - Retraining panel renders below chat when activated
  - Practice plan and prediction questions added to suggested prompts
  - Page compiles without errors
  - Existing chat functionality unchanged
  </done>
</task>

</tasks>

<verification>
python -m py_compile components/prediction_interval.py components/retraining_ui.py components/__init__.py
python -m py_compile "pages/4_ðŸ¤–_AI_Coach.py"
python -m unittest discover -s tests -v  # Full regression check
</verification>

<success_criteria>
1. render_prediction_interval shows point estimate + Plotly interval visualization with confidence percentage
2. render_retraining_ui has retrain button that trains model with progress feedback
3. AI Coach page shows model status in sidebar and retraining panel on demand
4. All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-ml-enhancement-coaching/03-04-SUMMARY.md`
</output>
