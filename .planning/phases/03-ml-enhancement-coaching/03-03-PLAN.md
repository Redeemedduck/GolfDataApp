---
phase: 03-ml-enhancement-coaching
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - local_coach.py
  - tests/unit/test_local_coach.py
autonomous: true

must_haves:
  truths:
    - "LocalCoach generates responses citing specific analytics metrics (e.g., 'Your 7-iron dispersion is 18 yards IQR')"
    - "Coach responses reference actual computed stats, not generic templates"
    - "LocalCoach integrates practice plan generation (get_practice_plan() returns structured plan)"
    - "Coach integrates prediction intervals when available (cites confidence interval in response)"
  artifacts:
    - path: "local_coach.py"
      provides: "Analytics-driven LocalCoach with practice plans and interval predictions"
      contains: "get_practice_plan"
    - path: "tests/unit/test_local_coach.py"
      provides: "Tests for analytics-driven responses and practice plan integration"
      contains: "test_analytics_driven"
  key_links:
    - from: "local_coach.py"
      to: "analytics/utils.py"
      via: "analytics data"
      pattern: "calculate_distance_stats|filter_outliers_iqr"
    - from: "local_coach.py"
      to: "ml/coaching/practice_planner.py"
      via: "practice plan generation"
      pattern: "PracticePlanner"
    - from: "local_coach.py"
      to: "ml/train_models.py"
      via: "interval predictions"
      pattern: "predict_with_intervals"
---

<objective>
Evolve LocalCoach from template-based to analytics-driven responses, integrate practice plan generation, and wire prediction intervals into coaching.

Purpose: Users get coaching responses that cite specific metrics ("Your 7-iron dispersion is 18 yards; focus on setup consistency") and can request personalized practice plans (COACH-01 + COACH-02 integration).

Output: Enhanced local_coach.py with analytics-driven handlers, practice plan method, interval integration, and updated tests.
</objective>

<execution_context>
@/Users/max1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/max1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@local_coach.py
@analytics/utils.py
@components/miss_tendency.py
@.planning/phases/03-ml-enhancement-coaching/03-01-SUMMARY.md
@.planning/phases/03-ml-enhancement-coaching/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend LocalCoach with analytics-driven responses and practice plan integration</name>
  <files>local_coach.py</files>
  <action>
  Modify `local_coach.py` to evolve from template-based to analytics-driven coaching:

  1. **Add imports** (all guarded with try/except):
     - `from analytics.utils import calculate_distance_stats, filter_outliers_iqr`
     - `from components.miss_tendency import _classify_shot_shape`
     - `from ml.coaching import PracticePlanner, WeaknessMapper` (guarded: set COACHING_AVAILABLE flag)

  2. **Add new intent pattern**:
     - `'practice_plan': r'\bpractice\s*plan\b|\bdrill\b|\bwhat.*work\s*on\b|\bpractice\b.*\bplan\b'`
     - Add handler mapping: `'practice_plan': self._handle_practice_plan`

  3. **Replace `_handle_club_stats`** with analytics-driven version:
     - Call `calculate_distance_stats(df, club)` from analytics.utils instead of internal `_calculate_club_stats`
     - If side_total column exists: compute dispersion IQR using `filter_outliers_iqr(club_df, 'side_total')`
     - If face_angle and club_path exist: classify shot shapes using `_classify_shot_shape` for each row, compute distribution
     - Build response message citing specific metrics:
       * "Your {club} analysis:"
       * "  - Median carry: {median} yards ({q25}-{q75} range)"
       * "  - Dispersion: {iqr} yards (IQR)" (if available)
       * "  - Shot shape: {dominant_pct}% {dominant_shape}" (if available)
       * "  - Based on {n} shots ({confidence} confidence)"
     - Generate suggestions based on actual data thresholds:
       * If dispersion IQR > 15: "High dispersion ({iqr} yards) - focus on setup consistency"
       * If dominant_shape in ['Slice', 'Fade'] and pct > 60: "Consistent {shape} pattern - work on face control"
       * If dominant_shape in ['Hook'] and pct > 40: "Hook tendency - check grip pressure"
       * If smash < 1.40: "Low smash factor ({smash:.2f}) - focus on center contact"
     - Keep original `_calculate_club_stats` as private fallback (rename to `_legacy_club_stats`)
     - If analytics import fails, fall back to legacy method

  4. **Add `get_practice_plan` method**:
     - `get_practice_plan(self, target_duration: int = 30, club: str = None) -> CoachResponse`:
     - If COACHING_AVAILABLE: create PracticePlanner, call generate_plan(df, target_duration, clubs=[club] if club else None)
     - Format PracticePlan into readable CoachResponse:
       * "Practice Plan ({duration} min):"
       * "Focus areas: {focus_areas}"
       * For each drill: "  {n}. {drill.name} ({drill.duration_min} min, {drill.reps} reps)"
       *   "     {drill.instructions}"
       * "Rationale: {rationale}"
     - Set CoachResponse.data to {'plan': plan_dict, 'weaknesses': weaknesses_dict}
     - If not COACHING_AVAILABLE: return basic suggestion response

  5. **Add `_handle_practice_plan` handler**:
     - Extract target duration from query if mentioned (e.g., "15 minute practice plan" -> 15)
     - Extract club from query if mentioned
     - Call get_practice_plan(target_duration, club)

  6. **Integrate prediction intervals into `predict_distance`**:
     - If self.distance_predictor has predict_with_intervals, call it
     - Include intervals in response: "Predicted carry: {value} yards ({lower}-{upper}, {confidence_level*100}% confidence)"
     - If intervals not available (HAS_MAPIE=False or insufficient data), include note: "Point estimate only - need 1000+ shots for confidence intervals"
     - Return interval data in dict alongside existing fields

  7. **Update `_handle_trends`** to use analytics stats:
     - Use calculate_distance_stats for per-session metrics instead of raw groupby
     - Cite specific metrics in trend message

  Key constraints:
  - All new imports MUST be try/except guarded for graceful degradation
  - Existing public API (get_response, predict_distance, etc.) MUST remain backward compatible
  - CoachResponse dataclass is unchanged
  - Keep existing _calculate_club_stats as _legacy_club_stats for fallback
  </action>
  <verify>
  python -m py_compile local_coach.py
  python -c "from local_coach import LocalCoach; coach = LocalCoach(); print('LocalCoach imports OK')"
  python -c "from local_coach import LocalCoach; coach = LocalCoach(); r = coach.get_response('practice plan'); print(r.message[:100])"
  </verify>
  <done>
  - LocalCoach responses cite specific analytics metrics (not generic templates)
  - get_practice_plan() returns structured plan with drills, durations, reps
  - predict_distance integrates interval data when available
  - All imports gracefully degrade
  - Backward compatible with existing public API
  </done>
</task>

<task type="auto">
  <name>Task 2: Update and extend LocalCoach tests for analytics-driven behavior</name>
  <files>tests/unit/test_local_coach.py</files>
  <action>
  Extend existing `tests/unit/test_local_coach.py` with new test cases:

  **TestAnalyticsDrivenResponses:**
  - test_club_stats_cites_metrics: mock golf_db.get_all_shots to return df with carry/side_total data, call get_response("How's my Driver?"), assert response message contains "Median carry" and numeric value, NOT just "avg"
  - test_club_stats_includes_dispersion: mock df with side_total data, assert response contains "Dispersion" and "IQR"
  - test_club_stats_includes_shot_shape: mock df with face_angle/club_path/side_spin, assert response contains shot shape percentage
  - test_club_stats_fallback_without_analytics: mock analytics import failure, assert legacy stats still work

  **TestPracticePlanIntegration:**
  - test_practice_plan_intent_detected: assert _detect_intent("practice plan") returns 'practice_plan'
  - test_drill_intent_detected: assert _detect_intent("what drills should I do") returns 'practice_plan'
  - test_practice_plan_response_has_drills: mock data with detectable weakness, call get_practice_plan(), assert response mentions drill name and reps
  - test_practice_plan_duration: call get_practice_plan(target_duration=15), assert response mentions "15 min" or similar
  - test_practice_plan_no_data: call get_practice_plan() with empty db, assert returns general plan (not error)

  **TestPredictionIntervals:**
  - test_predict_distance_with_intervals: mock predictor with predict_with_intervals, assert response includes lower_bound and upper_bound
  - test_predict_distance_without_intervals: mock predictor without MAPIE, assert response includes fallback note

  Use unittest.mock.patch for golf_db.get_all_shots and analytics imports.
  Build on existing test patterns in the file.
  </action>
  <verify>
  python -m unittest tests.unit.test_local_coach -v
  python -m py_compile tests/unit/test_local_coach.py
  </verify>
  <done>
  - All new tests pass (10+ new test cases)
  - Existing tests still pass (no regressions)
  - Tests verify: analytics citations in responses, practice plan generation, interval integration, graceful fallback
  </done>
</task>

</tasks>

<verification>
python -m py_compile local_coach.py
python -m unittest tests.unit.test_local_coach -v
python -m unittest discover -s tests -v  # Full regression check
</verification>

<success_criteria>
1. LocalCoach.get_response("How's my 7-iron?") returns response citing median carry, dispersion IQR, and shot shape from analytics â€” not generic templates
2. LocalCoach.get_practice_plan() returns CoachResponse with structured drills, durations, and rationale
3. predict_distance() returns interval data when available
4. All 207+ existing tests pass plus 10+ new tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-ml-enhancement-coaching/03-03-SUMMARY.md`
</output>
