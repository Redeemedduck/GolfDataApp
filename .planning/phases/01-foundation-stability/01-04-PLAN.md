---
phase: 01-foundation-stability
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [golf_db.py, tests/test_golf_db.py]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Session metrics table exists after init_db() and accepts INSERT OR REPLACE"
    - "update_session_metrics() successfully stores aggregate stats without OperationalError"
    - "get_session_metrics() retrieves stored metrics by session_id"
    - "Existing tests for session metrics pass end-to-end"
  artifacts:
    - path: "golf_db.py"
      provides: "CREATE TABLE IF NOT EXISTS session_stats in init_db()"
      contains: "CREATE TABLE IF NOT EXISTS session_stats"
  key_links:
    - from: "golf_db.py init_db()"
      to: "session_stats table"
      via: "CREATE TABLE IF NOT EXISTS"
      pattern: "CREATE TABLE IF NOT EXISTS session_stats"
    - from: "golf_db.py update_session_metrics()"
      to: "session_stats table"
      via: "INSERT OR REPLACE"
      pattern: "INSERT OR REPLACE INTO session_stats"
---

<objective>
Add the missing CREATE TABLE IF NOT EXISTS session_stats statement to init_db() in golf_db.py.

Purpose: Close the gap identified by verification — update_session_metrics() attempts INSERT into session_stats, but the table is never created. Any call crashes with sqlite3.OperationalError: no such table: session_stats. This blocks FNDTN-04.

Output: golf_db.py with session_stats table created in init_db(); all session metrics tests pass.
</objective>

<execution_context>
@/Users/max1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/max1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-stability/01-03-SUMMARY.md
@.planning/phases/01-foundation-stability/01-VERIFICATION.md
@golf_db.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session_stats CREATE TABLE to init_db()</name>
  <files>golf_db.py</files>
  <action>
In golf_db.py, inside init_db(), add a CREATE TABLE IF NOT EXISTS session_stats statement AFTER the sync_status table creation (after line 170, before conn.commit() on line 172).

The table must include ALL columns used in the INSERT OR REPLACE statement at line 2109:
- session_id TEXT PRIMARY KEY
- session_date TIMESTAMP
- session_type TEXT
- shot_count INTEGER
- clubs_used TEXT
- avg_carry REAL
- avg_total REAL
- avg_ball_speed REAL
- avg_club_speed REAL
- avg_smash REAL
- best_carry REAL
- avg_face_angle REAL
- std_face_angle REAL
- avg_club_path REAL
- std_club_path REAL
- avg_face_to_path REAL
- avg_strike_distance REAL
- std_strike_distance REAL
- updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP

Follow the exact same pattern used by the other CREATE TABLE statements in init_db():
```python
    # Create session stats table for aggregate session metrics
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS session_stats (
            session_id TEXT PRIMARY KEY,
            ...
        )
    ''')
```

Also add an index on session_date for trend queries:
```python
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_session_stats_date ON session_stats(session_date)')
```

Do NOT modify update_session_metrics(), get_session_metrics(), or any other existing code. Only add the table creation and index.
  </action>
  <verify>
1. `python -m py_compile golf_db.py` — no syntax errors
2. `python -c "import golf_db; golf_db.SQLITE_DB_PATH = '/tmp/test_gap_fix.db'; golf_db.init_db(); import sqlite3; conn = sqlite3.connect('/tmp/test_gap_fix.db'); tables = [r[0] for r in conn.execute(\"SELECT name FROM sqlite_master WHERE type='table'\").fetchall()]; assert 'session_stats' in tables, f'session_stats not found in {tables}'; print('PASS: session_stats table exists')"` — confirms table created
3. `python -m unittest tests.test_golf_db.TestSessionMetrics -v` — all 6 session metrics tests pass
  </verify>
  <done>
session_stats table is created by init_db(). update_session_metrics() no longer crashes. All TestSessionMetrics tests pass. FNDTN-04 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
1. `python -m py_compile golf_db.py` passes
2. `python -m unittest tests.test_golf_db -v` — all tests pass including TestSessionMetrics
3. Grep confirms CREATE TABLE IF NOT EXISTS session_stats exists in init_db()
4. The table has all 19 columns matching the INSERT statement in update_session_metrics()
</verification>

<success_criteria>
- session_stats table is created when init_db() runs
- update_session_metrics() can store metrics without OperationalError
- get_session_metrics() retrieves stored metrics
- All 6 TestSessionMetrics tests pass
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-stability/01-04-SUMMARY.md`
</output>
