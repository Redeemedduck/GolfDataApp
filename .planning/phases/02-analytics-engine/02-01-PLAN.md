---
phase: 02-analytics-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - analytics/__init__.py
  - analytics/utils.py
  - components/dispersion_chart.py
  - components/distance_table.py
autonomous: true

must_haves:
  truths:
    - "Shared analytics utilities (IQR filtering, normalization, min-sample checks) are importable and reusable"
    - "User views shot dispersion scatter plot per club with outlier filtering; patterns are visually clear"
    - "User sees median carry/total distances with IQR ranges instead of misleading maximums"
  artifacts:
    - path: "analytics/__init__.py"
      provides: "Analytics package entry point"
      contains: "from .utils import"
    - path: "analytics/utils.py"
      provides: "Shared analytics utility functions"
      exports: ["filter_outliers_iqr", "normalize_score", "normalize_inverse", "check_min_samples"]
    - path: "components/dispersion_chart.py"
      provides: "Shot dispersion scatter plot component"
      exports: ["render_dispersion_chart"]
    - path: "components/distance_table.py"
      provides: "Club distance table component"
      exports: ["render_distance_table"]
  key_links:
    - from: "components/dispersion_chart.py"
      to: "analytics/utils.py"
      via: "import filter_outliers_iqr"
      pattern: "from analytics.utils import filter_outliers_iqr"
    - from: "components/distance_table.py"
      to: "analytics/utils.py"
      via: "import filter_outliers_iqr"
      pattern: "from analytics.utils import filter_outliers_iqr"
---

<objective>
Create analytics utility module and implement shot dispersion chart (ANLYT-01) and true distance table (ANLYT-02).

Purpose: Establish shared analytics utilities (IQR outlier filtering, normalization, min-sample checks) that all Phase 2 components need, then build the two most impactful analytics features: dispersion patterns and true club distances.

Output: `analytics/utils.py` package, `components/dispersion_chart.py`, `components/distance_table.py`
</objective>

<execution_context>
@/Users/max1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/max1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-analytics-engine/02-RESEARCH.md

Key codebase references:
@components/heatmap_chart.py (established render_* pattern)
@components/trend_chart.py (established Plotly + Streamlit pattern)
@golf_db.py (shots table schema: carry, total, club, side_distance, smash, ball_speed, launch_angle, face_angle, club_path, side_spin)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics utility module with shared functions</name>
  <files>analytics/__init__.py, analytics/utils.py</files>
  <action>
Create new `analytics/` package with shared utility functions used across all Phase 2 components.

**analytics/__init__.py:**
- Import and re-export all public functions from utils.py
- Docstring explaining the analytics package purpose

**analytics/utils.py:**
Implement these functions:

1. `filter_outliers_iqr(df: pd.DataFrame, column: str, multiplier: float = 1.5) -> pd.DataFrame`
   - Use scipy.stats.iqr with nan_policy='omit'
   - Calculate Q1, Q3, bounds as Q1 - multiplier*IQR and Q3 + multiplier*IQR
   - Return filtered DataFrame (rows within bounds)
   - Handle edge cases: empty DataFrame, all-NaN column, fewer than 3 values (return unfiltered)

2. `check_min_samples(data, min_n: int = 3, context: str = "") -> tuple[bool, str]`
   - Returns (is_sufficient, message)
   - message like "Need 3+ shots for Driver analysis" if insufficient

3. `normalize_score(value: float, min_val: float, max_val: float) -> float`
   - Normalize to 0-100 scale, clamped to [0, 100]
   - Handle min_val == max_val (return 50.0)

4. `normalize_inverse(value: float, min_val: float, max_val: float) -> float`
   - Inverse normalize (lower raw value = higher score)
   - Returns 100 - normalize_score(value, min_val, max_val)

5. `calculate_distance_stats(df: pd.DataFrame, club: str) -> dict | None`
   - Filter to club, get carry column, dropna
   - If fewer than 3 shots, return None
   - Apply IQR filter
   - Return dict: median, q25, q75, iqr, max, sample_size, outliers_removed, confidence ('low'/<5, 'medium'/<10, 'high'/>=10)

All functions must handle empty DataFrames and NaN values gracefully. Use type hints. Follow existing code style (4-space indent, snake_case).
  </action>
  <verify>
`python -c "from analytics.utils import filter_outliers_iqr, check_min_samples, normalize_score, normalize_inverse, calculate_distance_stats; print('OK')"` prints OK.
`python -m py_compile analytics/__init__.py && python -m py_compile analytics/utils.py` succeeds.
  </verify>
  <done>All 5 utility functions importable, handle edge cases (empty data, NaN, small samples), and pass py_compile.</done>
</task>

<task type="auto">
  <name>Task 2: Create dispersion chart and distance table components</name>
  <files>components/dispersion_chart.py, components/distance_table.py</files>
  <action>
**components/dispersion_chart.py** (ANLYT-01):
Implement `render_dispersion_chart(df: pd.DataFrame, selected_club: str = None) -> None`:
- Follow established pattern from heatmap_chart.py: subheader, empty check, filter, plot, stats
- If selected_club provided, filter df to that club
- Check min samples (3+ shots) using analytics.utils.check_min_samples
- Apply filter_outliers_iqr on 'carry' column; track outlier count
- Create Plotly scatter: x=side_distance, y=carry
  - marker color = smash factor (colorscale='Viridis', colorbar title="Smash Factor")
  - marker size = 10
  - hovertemplate showing club, carry, side distance, ball_speed, launch_angle
- Add median crosshair lines (horizontal at median carry, vertical at 0 side_distance) in dashed red
- Update layout: title with club name and shot count, axis titles "Side Distance (yds)" and "Carry Distance (yds)", hovermode='closest'
- Display st.plotly_chart with use_container_width=True
- Show stats row (st.columns(4)): Median Carry, IQR spread (Q75-Q25), Side Spread (std of side_distance), Shots Shown
- Show caption: "N shots shown (M outliers filtered)" using outlier count

**components/distance_table.py** (ANLYT-02):
Implement `render_distance_table(df: pd.DataFrame) -> None`:
- Follow established pattern: subheader, empty check, compute, display
- Group shots by club
- For each club with 3+ shots, call analytics.utils.calculate_distance_stats
- Also compute total distance stats (same approach on 'total' column)
- Build summary DataFrame with columns: Club, Typical Carry (median), Carry Range (Q25-Q75 as string "238-252"), Best Carry (max), Typical Total (median total), Shots, Confidence
- Sort by median carry descending (longest club first)
- Display using st.dataframe with column_config:
  - Confidence column with color coding ("high"=green, "medium"=yellow, "low"=red) via st.column_config.TextColumn
- Below table, show st.info with interpretation: "Typical = median (50th percentile). Range = middle 50% of shots (IQR). More reliable than maximum for club selection."
- Handle clubs with fewer than 3 shots: list them at bottom with st.caption "Clubs with insufficient data (< 3 shots): ..."
  </action>
  <verify>
`python -m py_compile components/dispersion_chart.py && python -m py_compile components/distance_table.py` succeeds.
`python -c "from components.dispersion_chart import render_dispersion_chart; from components.distance_table import render_distance_table; print('OK')"` prints OK.
  </verify>
  <done>Dispersion chart renders scatter plot with IQR filtering and stats; distance table shows median/IQR per club sorted by distance with confidence indicators.</done>
</task>

</tasks>

<verification>
1. `python -m py_compile analytics/__init__.py analytics/utils.py components/dispersion_chart.py components/distance_table.py` — all pass
2. `python -c "from analytics.utils import filter_outliers_iqr, normalize_score, calculate_distance_stats"` — imports work
3. `python -c "from components.dispersion_chart import render_dispersion_chart; from components.distance_table import render_distance_table"` — imports work
4. `python -m unittest discover -s tests` — existing tests still pass (no regressions)
</verification>

<success_criteria>
- analytics/utils.py provides IQR filtering, normalization, min-sample checks, distance stats calculation
- Dispersion chart renders per-club scatter plot with outlier filtering and statistical summary
- Distance table shows median/IQR distances per club with confidence indicators, sorted longest-first
- All existing tests pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/02-analytics-engine/02-01-SUMMARY.md`
</output>
