---
phase: 02-analytics-engine
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - components/miss_tendency.py
  - components/progress_tracker.py
autonomous: true

must_haves:
  truths:
    - "User sees miss tendency breakdown (% straight/draw/fade/hook/slice) per club"
    - "User tracks session-over-session progress with trend lines and statistical significance"
  artifacts:
    - path: "components/miss_tendency.py"
      provides: "Miss tendency breakdown component"
      exports: ["render_miss_tendency"]
    - path: "components/progress_tracker.py"
      provides: "Session progress tracking component"
      exports: ["render_progress_tracker"]
  key_links:
    - from: "components/miss_tendency.py"
      to: "analytics/utils.py"
      via: "import check_min_samples"
      pattern: "from analytics.utils import"
    - from: "components/progress_tracker.py"
      to: "scipy.stats"
      via: "linregress for trend significance"
      pattern: "from scipy import stats"
---

<objective>
Implement miss tendency analysis (ANLYT-03) and session progress tracking (ANLYT-04).

Purpose: Give users visibility into their shot shape patterns per club and track improvement across sessions with statistical rigor. Miss tendencies inform swing corrections; progress trends motivate continued practice.

Output: `components/miss_tendency.py`, `components/progress_tracker.py`
</objective>

<execution_context>
@/Users/max1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/max1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-analytics-engine/02-RESEARCH.md
@.planning/phases/02-analytics-engine/02-01-SUMMARY.md

Key codebase references:
@components/heatmap_chart.py (established render_* pattern)
@components/trend_chart.py (existing trend chart with np.polyfit — extend with significance)
@ml/classifiers.py (existing ShotShapeClassifier with D-plane theory)
@local_coach.py (existing classify_shot_shape usage, lines ~517-540)
@analytics/utils.py (shared utilities from plan 01)
@golf_db.py (session_stats table: avg_carry, avg_smash, std_face_angle, std_club_path, etc.)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create miss tendency component with D-plane classification</name>
  <files>components/miss_tendency.py</files>
  <action>
Implement `render_miss_tendency(df: pd.DataFrame, selected_club: str = None) -> None`:

Follow established render_* pattern from heatmap_chart.py.

**Shot shape classification function** (internal to this module):
`_classify_shot_shape(face_angle: float, club_path: float, side_spin: int) -> str`
- Use D-plane theory thresholds from research:
  - face_to_path = face_angle - club_path
  - abs(face_to_path) < 2.0 AND abs(side_spin) < 300 -> 'Straight'
  - face_to_path < -6.0 -> 'Hook'; < -2.0 -> 'Draw'
  - face_to_path > 6.0 -> 'Slice'; > 2.0 -> 'Fade'
  - Default: 'Straight'
- Note: This is a standalone rule-based classifier for analytics. It does NOT depend on ml.ShotShapeClassifier (which requires sklearn). This keeps analytics working even without ML dependencies.

**Main render function:**
1. Subheader "Miss Tendency Analysis"
2. Empty check; check required columns exist (face_angle, club_path, side_spin) — show st.warning if missing
3. If selected_club, filter to that club
4. Check min samples (5+ shots for meaningful tendency) using analytics.utils.check_min_samples
5. Apply _classify_shot_shape to each row: `df['shot_shape'] = df.apply(lambda r: _classify_shot_shape(r['face_angle'], r['club_path'], r['side_spin']), axis=1)`
6. Count by shape, calculate percentages
7. Create Plotly horizontal bar chart:
   - y = shot shape names, x = percentage
   - Color map: Straight=#4CAF50 (green), Draw=#2196F3 (blue), Fade=#FF9800 (orange), Hook=#F44336 (red), Slice=#9C27B0 (purple)
   - Show percentage labels on bars
   - Title includes club name and shot count
8. Display with st.plotly_chart
9. Below chart, show dominant tendency with coaching tip:
   - Straight dominant: "Great ball-striking! Your shots are predominantly straight."
   - Draw/Fade dominant: "Your dominant miss is {shape}. Face-to-path avg: {avg:.1f} degrees."
   - Hook: "You're hooking frequently. Check grip pressure and face control at impact."
   - Slice: "You're slicing frequently. Work on in-to-out swing path and closing the face."
10. Show st.expander "Understanding miss tendencies" with brief D-plane explanation: face angle determines initial direction, face-to-path difference determines curve.
  </action>
  <verify>
`python -m py_compile components/miss_tendency.py` succeeds.
`python -c "from components.miss_tendency import render_miss_tendency; print('OK')"` prints OK.
  </verify>
  <done>Miss tendency chart shows per-club shot shape breakdown with D-plane classification, percentage bars, coaching tips, and educational explanation. Works without ML dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Create progress tracker component with statistical significance</name>
  <files>components/progress_tracker.py</files>
  <action>
Implement `render_progress_tracker(df: pd.DataFrame, metric: str = 'carry') -> None`:

Follow established render_* pattern. This EXTENDS the existing trend_chart.py concept with statistical significance (existing trend_chart.py uses np.polyfit without p-values; this adds scipy.stats.linregress and significance indicators).

**Internal helper:**
`_calculate_trend(values: list[float]) -> dict`
- Use scipy.stats.linregress(x, values) where x = np.arange(len(values))
- Return dict: slope, intercept, r_squared, p_value, is_significant (p<0.05 AND n>=5), improvement_pct, message
- If fewer than 3 values: return dict with is_significant=False, note="Need 3+ sessions"

**Main render function:**
1. Subheader "Progress Tracker"
2. Empty check
3. Aggregate per session: group by session_id, compute median of selected metric per session
   - Also capture session_date for each session (first non-null session_date in group)
   - Sort by session_date ascending
4. Check min sessions (3+ for any trend, 5+ for significance)
5. Call _calculate_trend on session medians list
6. Create Plotly figure:
   - Scatter + line for actual session medians (mode='lines+markers', color='royalblue')
   - If 2+ sessions: add trend line (dashed, color based on significance):
     - Significant improving: green dashed line, label "Improving (p={p_value:.3f})"
     - Significant declining: red dashed line, label "Declining (p={p_value:.3f})"
     - Not significant: gray dotted line, label "Trend not significant"
   - x axis = session dates, y axis = metric value
   - Hover showing session ID, date, metric value
7. Display with st.plotly_chart
8. Show metrics row (st.columns(4)):
   - Sessions: count
   - Change: improvement_pct with delta color (positive=green if metric is carry/ball_speed/smash, negative=green if metric is std_face_angle)
   - R-squared: r_squared value
   - Significance: "Yes (p={:.3f})" or "Not yet (n={count})" in appropriate color
9. If not significant and n < 5, show st.info "Keep practicing! Need 5+ sessions for statistically significant trend detection."
10. If significant and improving, show st.success with the trend message.
11. If significant and declining, show st.warning with the trend message.

**Supported metrics** (validated before rendering):
carry, total, ball_speed, club_speed, smash, face_angle, club_path — show appropriate labels. Unknown metrics: show warning.
  </action>
  <verify>
`python -m py_compile components/progress_tracker.py` succeeds.
`python -c "from components.progress_tracker import render_progress_tracker; print('OK')"` prints OK.
  </verify>
  <done>Progress tracker shows session-over-session trend with scipy-based statistical significance, color-coded trend lines, improvement percentage, and contextual messages about significance.</done>
</task>

</tasks>

<verification>
1. `python -m py_compile components/miss_tendency.py components/progress_tracker.py` — both pass
2. `python -c "from components.miss_tendency import render_miss_tendency; from components.progress_tracker import render_progress_tracker"` — imports work
3. `python -m unittest discover -s tests` — existing tests still pass
4. Miss tendency uses rule-based D-plane classification (no ML dependency required)
5. Progress tracker uses scipy.stats.linregress for p-values (not just np.polyfit)
</verification>

<success_criteria>
- Miss tendency shows shot shape breakdown per club with D-plane classification and coaching tips
- Progress tracker shows session trends with statistical significance indicators
- Both components follow established render_*(df, **kwargs) pattern
- No ML dependencies required for either component (scipy is already installed)
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-analytics-engine/02-02-SUMMARY.md`
</output>
